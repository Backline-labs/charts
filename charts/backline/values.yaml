# Global configuration
accessKey: ""
environment: "production"
namespaceOverride: "backline"

# ============================================================================
# MINIO OBJECT STORAGE (Subchart)
# ============================================================================
minio:
  enabled: true
  fullnameOverride: minio
  # Standalone mode (single node)
  mode: standalone
  # Root credentials
  rootUser: "backline"
  rootPassword: "backline-minio-password"
  # Persistence configuration
  persistence:
    enabled: true
    size: 10Gi
    storageClass: ""
  # Resource configuration
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  # Service configuration
  service:
    type: ClusterIP
    port: 9000
  # Disable web console
  consoleEnabled: false
  # Default buckets to create
  buckets:
    - name: static-assets
      policy: none
      purge: false
      objectlocking: false
    - name: operational
      policy: none
      purge: false
      objectlocking: false
  # Post-install job for bucket creation
  postJob:
    enabled: true

# Janitor component
janitor:
  image:
    registry: docker.io
    name: dtzar/helm-kubectl
    tag: 3.16.1
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Worker component
worker:
  replicaCount: 1
  image:
    # Override the registry (useful for local/on-prem with Tilt)
    # Example: "localhost:5000" or leave empty for default ECR
    registry: ""
    name: prod-runner
    tag: "latest"
    pullPolicy: IfNotPresent
  service:
    httpPort: 8080
  modelName: "bedrock/us.anthropic.claude-sonnet-4-5-20250929-v1:0"
  structuredOutputModelName: "claude-haiku-4-5-20251001"
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "2Gi"
  livenessProbe:
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 5
  readinessProbe:
    httpGet:
      path: /readiness
      port: 8080
    initialDelaySeconds: 5
    periodSeconds: 3
  nodeSelector: {}
  tolerations: []
  affinity: {}
  otel:
    enabled: true
    collector:
      image: public.ecr.aws/aws-observability/aws-otel-collector:v0.45.1

# ============================================================================
# JOB SPECIFICATIONS
# ============================================================================

# Coder Job Configuration
coderJob:
  activeDeadlineSeconds: 3600
  backoffLimit: 0
  restartPolicy: Never

  # Image configuration
  image:
    name: ""  # Auto-filled by worker
    tag: ""
    pullPolicy: IfNotPresent

  # Pod security context
  podSecurityContext:
    runAsUser: 1020
    runAsGroup: 1010
    fsGroup: 1010
    fsGroupChangePolicy: OnRootMismatch
    runAsNonRoot: true

  # Container security context
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    capabilities:
      drop:
        - ALL

  # Base volumes (always included)
  volumes:
    - name: home-volume
      emptyDir: {}
    - name: tmp-volume
      emptyDir: {}

  # Base volume mounts (always included)
  volumeMounts:
    - name: home-volume
      mountPath: /home/app_user
    - name: tmp-volume
      mountPath: /tmp

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

# Upgrader Job Configuration (Dependabot)
upgraderJob:
  activeDeadlineSeconds: 3600
  backoffLimit: 0
  restartPolicy: Never

  # Pod security context
  podSecurityContext:
    privileged: false
    fsGroup: 1000
    fsGroupChangePolicy: OnRootMismatch

  # Main container configuration
  container:
    name: dependabot-updater
    image:
      name: ""  # Auto-filled by worker based on package manager
      tag: ""
      pullPolicy: IfNotPresent
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      capabilities:
        drop:
          - ALL
    volumeMounts:
      - name: repo
        mountPath: /home/dependabot/dependabot-updater/repo

  # Base volumes (always included)
  volumes:
    - name: repo
      emptyDir: {}

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

# ============================================================================
# RESOURCE PROFILES FOR EPHEMERAL JOBS
# ============================================================================
resourceProfiles:
  small:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "1000m"
      memory: "2Gi"
  medium:
    requests:
      cpu: "2000m"
      memory: "8Gi"
    limits:
      cpu: "2000m"
      memory: "8Gi"
  large:
    requests:
      cpu: "4000m"
      memory: "16Gi"
    limits:
      cpu: "4000m"
      memory: "16Gi"
  xlarge:
    requests:
      cpu: "8000m"
      memory: "32Gi"
    limits:
      cpu: "8000m"
      memory: "32Gi"
